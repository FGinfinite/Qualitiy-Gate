# 字符串长度排序功能使用文档

## 功能说明

新增的字符串长度排序功能可以在阶段2数据选择时按照字符串长度降序排列数据，确保：
1. 长文本数据优先处理
2. 同批次内文本长度相似，减少padding
3. 最大显存占用发生在开始阶段，避免后续突然爆显存
4. 快速排序，适用于大数据集

## 配置启用

在 `configs/stage_2_selection.yaml` 中：

```yaml
dataset:
  # 启用字符串长度排序
  sort_by_length: true  # 是否按字符串长度降序排列数据（推荐开启以优化推理效率）

  # 注意：如果启用排序，shuffle将被自动禁用
  shuffle: false  # 建议设为false以避免混淆
```

## 使用方法

### 方法1：通过配置文件

直接运行阶段2脚本，排序功能会自动生效：

```bash
CUDA_VISIBLE_DEVICES=0 bash scripts/run_stage_2.sh model_checkpoint_path=outputs/stage_1_warmup/YYYY-MM-DD/HH-MM-SS/full_rank_weights.pt
```

### 方法2：通过命令行参数覆盖

临时启用或禁用排序功能：

```bash
# 启用排序
CUDA_VISIBLE_DEVICES=0 bash scripts/run_stage_2.sh dataset.sort_by_length=true

# 禁用排序
CUDA_VISIBLE_DEVICES=0 bash scripts/run_stage_2.sh dataset.sort_by_length=false
```

## 日志输出示例

启用排序功能后，您会看到类似的日志输出：

```
INFO - 启用字符串长度排序功能...
计算字符串长度: 100%|██████████| 50000/50000 [00:02<00:00, 20435.12it/s]
INFO - 字符串长度计算完成，平均长度: 234.56
INFO - 长度范围: 15 - 2048
INFO - 按字符串长度降序排列数据集
INFO - 排序前长度范围: 15 - 2048
INFO - 排序后前5个长度: [2048, 2045, 2041, 2039, 2035]
INFO - 排序后后5个长度: [18, 17, 16, 16, 15]
INFO - ✓ 数据集已按字符串长度降序排列
```

## 排序原理

### 字符串长度计算
- 计算每个样本中所有消息的role和content字段的字符总长度
- 不需要分词器，计算速度非常快
- 虽然不如token长度精确，但对于排序目的来说足够准确

### 排序效果
- 长文本样本排在前面，短文本样本排在后面
- 保持数据选择结果的确定性（与顺序无关）
- 显著提升推理效率

## 性能影响

- **额外时间**：初始排序仅需30秒-2分钟（取决于数据集大小）
- **推理效率**：可显著提升后续推理效率，减少padding开销
- **显存管理**：避免推理过程中的突然显存峰值
- **内存占用**：排序过程内存占用极小

## 注意事项

1. **兼容性**：与shuffle功能互斥，启用排序时会自动禁用shuffle
2. **容错性**：如果排序失败，系统会回退到原始数据顺序并继续运行
3. **数据完整性**：排序不会改变或丢失任何数据，只改变顺序
4. **适用场景**：特别适合大数据集，速度快，效果好